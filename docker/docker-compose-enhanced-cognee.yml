version: '3.8'

# Enhanced Cognee Memory Stack - Production Configuration
# Replaces default Cognee stack with enterprise-grade components
# Components: PostgreSQL+pgVector, Qdrant, Neo4j, Redis, Enhanced Cognee

networks:
  cognee-network:
    driver: overlay
    attachable: true
  ats_network:
    driver: overlay
    attachable: true
  oma_network:
    driver: overlay
    attachable: true
  smc_network:
    driver: overlay
    attachable: true

volumes:
  postgres_data:
    driver: local
  qdrant_storage:
    driver: local
  neo4j_data:
    driver: local
  neo4j_logs:
    driver: local
  neo4j_import:
    driver: local
  redis_data:
    driver: local
  enhanced_cognee_data:
    driver: local

services:
  # PostgreSQL 18 + pgVector - Enhanced Relational Database (replaces SQLite)
  postgres:
    image: pgvector/pgvector:pg18  # UPGRADED to PostgreSQL 18 with pgVector
    container_name: postgres-enhanced-cognee
    environment:
      POSTGRES_DB: cognee_db
      POSTGRES_USER: cognee_user
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-cognee_password}
      POSTGRES_HOST_AUTH_METHOD: trust
      # PostgreSQL 18 specific optimizations
      POSTGRES_INITDB_ARGS: "--encoding=UTF-8 --lc-collate=C --lc-ctype=C"
      POSTGRES_SHARED_PRELOAD_LIBRARIES: "vector"
    volumes:
      - postgres_data:/var/lib/postgresql/data
      - ./init-scripts:/docker-entrypoint-initdb.d
      - ./postgresql18.conf:/etc/postgresql/postgresql.conf:ro  # PostgreSQL 18 config
    ports:
      - "25432:5432"  # PostgreSQL (changed to avoid conflict)
    networks:
      - cognee-network
    deploy:
      replicas: 1
      placement:
        constraints:
          - node.role == manager
      resources:
        limits:
          memory: 4G  # Increased for PostgreSQL 18 performance
        reservations:
          memory: 2G  # Increased for PostgreSQL 18 performance
    restart: unless-stopped
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U cognee_user -d cognee_db"]
      interval: 30s
      timeout: 10s
      retries: 3

  # Qdrant - Enhanced Vector Database (replaces LanceDB)
  qdrant:
    image: qdrant/qdrant:v1.11.1
    container_name: qdrant-enhanced-cognee
    environment:
      QDRANT__SERVICE__HTTP_PORT: 6333
      QDRANT__SERVICE__GRPC_PORT: 6334
      QDRANT__LOG_LEVEL: INFO
      QDRANT__SERVICE__MAX_REQUEST_SIZE_MB: 32
      QDRANT__STORAGE__PERFORMANCE__MAX_SEARCH_THREADS: 4
      QDRANT__STORAGE__PERFORMANCE__MAX_OPTIMIZATION_THREADS: 1
    volumes:
      - qdrant_storage:/qdrant/storage
    ports:
      - "26333:6333"  # HTTP API (changed to avoid conflict)
      - "26334:6334"  # gRPC API (changed to avoid conflict)
    networks:
      - cognee-network
    deploy:
      replicas: 1
      placement:
        constraints:
          - node.role == manager
      resources:
        limits:
          memory: 4G
        reservations:
          memory: 2G
    restart: unless-stopped
    healthcheck:
      test: ["CMD-SHELL", "echo > /dev/tcp/localhost/6333 || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 3

  # Neo4j - Enhanced Graph Database (replaces Kuzu)
  neo4j:
    image: neo4j:5.25-community
    container_name: neo4j-enhanced-cognee
    environment:
      NEO4J_AUTH: neo4j/${NEO4J_PASSWORD:-cognee_password}
      NEO4J_PLUGINS: '["apoc", "graph-data-science"]'
      # NEO4J_dbms_default__database: cognee_graph
      NEO4J_dbms_server_config_strict_validation_enabled: false
      NEO4J_dbms_security_procedures_unrestricted: apoc.*
      NEO4J_dbms_memory_heap_initial_size: 1G
      NEO4J_dbms_memory_heap_max_size: 2G
      NEO4J_dbms_memory_pagecache_size: 1G
      NEO4J_dbms_default_listen_address: 0.0.0.0
      NEO4J_dbms_connector_bolt_listen_address: 0.0.0.0:7687
      NEO4J_dbms_connector_http_listen_address: 0.0.0.0:7474
    volumes:
      - neo4j_data:/data
      - neo4j_logs:/logs
      - neo4j_import:/var/lib/neo4j/import
    ports:
      - "27474:7474"  # HTTP (changed to avoid conflict)
      - "27687:7687"  # Bolt (changed to avoid conflict)
    networks:
      - cognee-network
    deploy:
      replicas: 1
      placement:
        constraints:
          - node.role == manager
      resources:
        limits:
          memory: 3G
        reservations:
          memory: 1G
    restart: unless-stopped
    healthcheck:
      test: ["CMD-SHELL", "wget --no-verbose --tries=1 --spider http://localhost:7474/browser/ || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 3

  # Redis - High-Performance Cache Layer (new component)
  redis:
    image: redis:7.4-alpine
    container_name: redis-enhanced-cognee
    command: redis-server --appendonly yes --maxmemory 1gb --maxmemory-policy allkeys-lru
    volumes:
      - redis_data:/data
    ports:
      - "26379:6379"  # Redis (changed to avoid conflict)
    networks:
      - cognee-network
    deploy:
      replicas: 1
      placement:
        constraints:
          - node.role == manager
      resources:
        limits:
          memory: 1.5G
        reservations:
          memory: 512M
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 30s
      timeout: 10s
      retries: 3

  # Enhanced Cognee MCP Server - Main Memory Provider
  enhanced-cognee:
    image: python:3.11-slim
    container_name: enhanced-cognee-server
    environment:
      # Enhanced Stack Configuration
      ENHANCED_COGNEE_MODE: "true"

      # PostgreSQL Configuration (replaces SQLite)
      POSTGRES_HOST: postgres
      POSTGRES_PORT: 5432
      POSTGRES_DB: cognee_db
      POSTGRES_USER: cognee_user
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-cognee_password}

      # Qdrant Configuration (replaces LanceDB)
      QDRANT_HOST: qdrant
      QDRANT_PORT: 6333
      QDRANT_API_KEY: ${QDRANT_API_KEY:-}
      QDRANT_COLLECTION_PREFIX: "cognee_"

      # Neo4j Configuration (replaces Kuzu)
      NEO4J_URI: bolt://neo4j:7687
      NEO4J_USER: neo4j
      NEO4J_PASSWORD: ${NEO4J_PASSWORD:-cognee_password}
      NEO4J_DATABASE: neo4j

      # Redis Configuration (new cache layer)
      REDIS_HOST: redis
      REDIS_PORT: 6379
      REDIS_PASSWORD: ${REDIS_PASSWORD:-}
      REDIS_DB: 0
      REDIS_CACHE_TTL: 3600

      # LLM Configuration (existing)
      LLM_API_KEY: ${LLM_API_KEY:-cfd27dbaef5a4cca98530c9cfeedee30.5wsme76tr426JBkP}
      LLM_MODEL: ${LLM_MODEL:-glm-4.6}
      LLM_PROVIDER: ${LLM_PROVIDER:-zai}
      LLM_ENDPOINT: ${LLM_ENDPOINT:-https://api.z.ai/v1}

      # Embedding Configuration (existing)
      EMBEDDING_PROVIDER: ${EMBEDDING_PROVIDER:-ollama}
      EMBEDDING_MODEL: ${EMBEDDING_MODEL:-snowflake-arctic-embed2:568m}
      EMBEDDING_ENDPOINT: ${EMBEDDING_ENDPOINT:-http://localhost:11434/api/embed}
      EMBEDDING_DIMENSIONS: ${EMBEDDING_DIMENSIONS:-1024}

      # Enhanced Features
      MEMORY_CATEGORIZATION: "true"
      ATS_MEMORY_PREFIX: "ats_"
      OMA_MEMORY_PREFIX: "oma_"
      SMC_MEMORY_PREFIX: "smc_"
      PERFORMANCE_MONITORING: "true"
      AUTO_OPTIMIZATION: "true"

      # Security Configuration
      ENV: "local"
      ACCEPT_LOCAL_FILE_PATH: "True"
      ALLOW_HTTP_REQUESTS: "True"
      ALLOW_CYPHER_QUERY: "True"
      TOKENIZERS_PARALLELISM: "false"
    volumes:
      - enhanced_cognee_data:/app/data
    ports:
      - "28080:8080"  # HTTP API (changed to avoid conflict)
    networks:
      - cognee-network
      - ats_network
      - oma_network
      - smc_network
    depends_on:
      postgres:
        condition: service_healthy
      qdrant:
        condition: service_healthy
      neo4j:
        condition: service_healthy
      redis:
        condition: service_healthy
    deploy:
      replicas: 1
      placement:
        constraints:
          - node.role == manager
      resources:
        limits:
          memory: 4G
        reservations:
          memory: 2G
      restart_policy:
        condition: on-failure
        delay: 5s
        max_attempts: 3
    restart: unless-stopped
    healthcheck:
      test: ["CMD-SHELL", "curl -f http://localhost:8080/health || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 3

  