# Enhanced Cognee Memory Stack - Hierarchical Configuration
# First Layer: cognee (main service)
# Second Layer: PostgreSQL+pgVector, Qdrant, Neo4j, Redis (within cognee service)

networks:
  cognee-network:
    driver: bridge
    attachable: true

volumes:
  postgres_data:
    driver: local
  qdrant_storage:
    driver: local
  neo4j_data:
    driver: local
  neo4j_logs:
    driver: local
  neo4j_import:
    driver: local
  redis_data:
    driver: local
  enhanced_cognee_data:
    driver: local

services:
  # ===========================================
  # FIRST LAYER: Enhanced Cognee Service
  # ===========================================
  cognee:
    image: python:3.11-slim
    container_name: enhanced-cognee
    build:
      context: .
      dockerfile: Dockerfile
    environment:
      # Enhanced Stack Configuration
      ENHANCED_COGNEE_MODE: "true"

      # ===========================================
      # SECOND LAYER: Database Services (configured via environment)
      # ===========================================

      # PostgreSQL + pgVector Configuration (replaces SQLite)
      POSTGRES_HOST: postgres
      POSTGRES_PORT: 5432
      POSTGRES_DB: cognee_db
      POSTGRES_USER: cognee_user
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-cognee_password}
      POSTGRES_SSL_MODE: disable
      POSTGRES_POOL_SIZE: 20
      POSTGRES_MAX_OVERFLOW: 30

      # Qdrant Vector Database Configuration (replaces LanceDB)
      QDRANT_HOST: qdrant
      QDRANT_PORT: 6333
      QDRANT_API_KEY: ${QDRANT_API_KEY:-}
      QDRANT_COLLECTION_PREFIX: "cognee_"
      QDRANT_TIMEOUT: 30
      QDRANT_RETRY_COUNT: 3
      QDRANT_BATCH_SIZE: 100

      # Neo4j Graph Database Configuration (replaces Kuzu)
      NEO4J_URI: bolt://neo4j:7687
      NEO4J_USER: neo4j
      NEO4J_PASSWORD: ${NEO4J_PASSWORD:-cognee_password}
      NEO4J_DATABASE: neo4j
      NEO4J_MAX_CONNECTION_POOL_SIZE: 50
      NEO4J_CONNECTION_ACQUISITION_TIMEOUT: 60

      # Redis Cache Layer Configuration (new component)
      REDIS_HOST: redis
      REDIS_PORT: 6379
      REDIS_PASSWORD: ${REDIS_PASSWORD:-}
      REDIS_DB: 0
      REDIS_CACHE_TTL: 3600
      REDIS_MAX_CONNECTIONS: 100
      REDIS_CONNECTION_POOL_SIZE: 20

      # LLM Configuration
      LLM_API_KEY: ${LLM_API_KEY:-cfd27dbaef5a4cca98530c9cfeedee30.5wsme76tr426JBkP}
      LLM_MODEL: ${LLM_MODEL:-glm-4.6}
      LLM_PROVIDER: ${LLM_PROVIDER:-zai}
      LLM_ENDPOINT: ${LLM_ENDPOINT:-https://api.z.ai/v1}

      # Embedding Configuration
      EMBEDDING_PROVIDER: ${EMBEDDING_PROVIDER:-ollama}
      EMBEDDING_MODEL: ${EMBEDDING_MODEL:-snowflake-arctic-embed2:568m}
      EMBEDDING_ENDPOINT: ${EMBEDDING_ENDPOINT:-http://host.docker.internal:11434/api/embed}
      EMBEDDING_DIMENSIONS: ${EMBEDDING_DIMENSIONS:-1024}
      HUGGINGFACE_TOKENIZER: ${HUGGINGFACE_TOKENIZER:-Snowflake/snowflake-arctic-embed2}

      # Enhanced Features
      MEMORY_CATEGORIZATION: "true"
      ATS_MEMORY_PREFIX: "ats_"
      OMA_MEMORY_PREFIX: "oma_"
      SMC_MEMORY_PREFIX: "smc_"
      PERFORMANCE_MONITORING: "true"
      AUTO_OPTIMIZATION: "true"
      INTELLIGENT_CACHING: "true"

      # Security Configuration
      ENV: "local"
      ACCEPT_LOCAL_FILE_PATH: "True"
      ALLOW_HTTP_REQUESTS: "True"
      ALLOW_CYPHER_QUERY: "True"
      TOKENIZERS_PARALLELISM: "false"

      # Application Configuration
      DEBUG: ${DEBUG:-false}
      HOST: 0.0.0.0
      LOG_LEVEL: ${LOG_LEVEL:-INFO}
      PYTHONUNBUFFERED: 1

    volumes:
      - enhanced_cognee_data:/app/data
      - ./cognee:/app/cognee
      - ./cognee-mcp:/app/cognee-mcp
      - ./.env:/app/.env

    ports:
      - "28080:8080"  # Enhanced Cognee HTTP API
      - "8000:8000"   # Cognee MCP Server Port

    networks:
      - cognee-network

    depends_on:
      postgres:
        condition: service_healthy
      qdrant:
        condition: service_healthy
      neo4j:
        condition: service_healthy
      redis:
        condition: service_healthy

    deploy:
      resources:
        limits:
          memory: 4G
          cpus: "2.0"
        reservations:
          memory: 2G
          cpus: "1.0"

    restart: unless-stopped

    healthcheck:
      test: ["CMD-SHELL", "curl -f http://localhost:8080/health || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s

  # ===========================================
  # SECOND LAYER: Database Services (within cognee ecosystem)
  # ===========================================

  # PostgreSQL + pgVector - Enhanced Relational Database
  postgres:
    image: pgvector/pgvector:pg16
    container_name: postgres-cognee
    environment:
      POSTGRES_DB: cognee_db
      POSTGRES_USER: cognee_user
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-cognee_password}
      POSTGRES_HOST_AUTH_METHOD: trust
      POSTGRES_INITDB_ARGS: "--data-checksums"

    volumes:
      - postgres_data:/var/lib/postgresql/data
      - ./docker/init-scripts/postgres:/docker-entrypoint-initdb.d

    ports:
      - "25432:5432"  # PostgreSQL (unique port to avoid conflicts)

    networks:
      - cognee-network

    deploy:
      resources:
        limits:
          memory: 2G
          cpus: "1.0"
        reservations:
          memory: 1G
          cpus: "0.5"

    restart: unless-stopped

    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U cognee_user -d cognee_db"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 30s

  # Qdrant - Enhanced Vector Database
  qdrant:
    image: qdrant/qdrant:v1.11.1
    container_name: qdrant-cognee
    environment:
      QDRANT__SERVICE__HTTP_PORT: 6333
      QDRANT__SERVICE__GRPC_PORT: 6334
      QDRANT__LOG_LEVEL: INFO
      QDRANT__SERVICE__MAX_REQUEST_SIZE_MB: 32
      QDRANT__STORAGE__PERFORMANCE__MAX_SEARCH_THREADS: 4
      QDRANT__STORAGE__PERFORMANCE__MAX_OPTIMIZATION_THREADS: 1
      QDRANT__STORAGE__PERFORMANCE__SECTOR_SIZE: 1gb
      QDRANT__SERVICE__TELEMETRY_DISABLED: "true"

    volumes:
      - qdrant_storage:/qdrant/storage

    ports:
      - "26333:6333"  # HTTP API (unique port to avoid conflicts)
      - "26334:6334"  # gRPC API (unique port to avoid conflicts)

    networks:
      - cognee-network

    deploy:
      resources:
        limits:
          memory: 4G
          cpus: "1.5"
        reservations:
          memory: 2G
          cpus: "0.8"

    restart: unless-stopped

    healthcheck:
      test: ["CMD-SHELL", "wget --no-verbose --tries=1 --spider http://localhost:6333/health || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 30s

  # Neo4j - Enhanced Graph Database
  neo4j:
    image: neo4j:5.25-community
    container_name: neo4j-cognee
    environment:
      # Authentication
      NEO4J_AUTH: neo4j/${NEO4J_PASSWORD:-cognee_password}
      NEO4J_PLUGINS: '["apoc", "graph-data-science"]'

      # Database Configuration
      NEO4J_dbms_default__database: neo4j
      NEO4J_dbms_databases_default__to__read__only: false

      # Memory Configuration
      NEO4J_dbms_memory_heap_initial_size: 1G
      NEO4J_dbms_memory_heap_max_size: 2G
      NEO4J_dbms_memory_pagecache_size: 1G

      # Network Configuration
      NEO4J_dbms_default_listen_address: 0.0.0.0
      NEO4J_dbms_connector_bolt_listen_address: 0.0.0.0:7687
      NEO4J_dbms_connector_http_listen_address: 0.0.0.0:7474

      # Security Configuration
      NEO4J_dbms_server_config_strict_validation_enabled: false
      NEO4J_dbms_security_procedures_unrestricted: apoc.*
      NEO4J_dbms_security_procedures_allowlist: apoc.*,gds.*

      # Performance Configuration
      NEO4J_dbms_tx__log_rotation_retention__policy: 100M size
      NEO4J_dbms_logs_debug_level: INFO

    volumes:
      - neo4j_data:/data
      - neo4j_logs:/logs
      - neo4j_import:/var/lib/neo4j/import

    ports:
      - "27474:7474"  # HTTP (unique port to avoid conflicts)
      - "27687:7687"  # Bolt (unique port to avoid conflicts)

    networks:
      - cognee-network

    deploy:
      resources:
        limits:
          memory: 3G
          cpus: "1.5"
        reservations:
          memory: 1G
          cpus: "0.8"

    restart: unless-stopped

    healthcheck:
      test: ["CMD-SHELL", "wget --no-verbose --tries=1 --spider http://localhost:7474/browser/ || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 60s

  # Redis - High-Performance Cache Layer
  redis:
    image: redis:7.4-alpine
    container_name: redis-cognee
    command: >
      redis-server
      --appendonly yes
      --maxmemory 1gb
      --maxmemory-policy allkeys-lru
      --save 900 1
      --save 300 10
      --save 60 10000
      --loglevel notice

    volumes:
      - redis_data:/data

    ports:
      - "26379:6379"  # Redis (unique port to avoid conflicts)

    networks:
      - cognee-network

    deploy:
      resources:
        limits:
          memory: 1.5G
          cpus: "0.5"
        reservations:
          memory: 512M
          cpus: "0.2"

    restart: unless-stopped

    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 30s
      timeout: 5s
      retries: 3
      start_period: 10s

# ===========================================
# MONITORING AND OBSERVABILITY
# ===========================================

  # Optional: Redis Insight for monitoring Redis
  redisinsight:
    image: redislabs/redisinsight:latest
    container_name: redisinsight-cognee
    ports:
      - "5540:8000"
    networks:
      - cognee-network
    depends_on:
      - redis
    deploy:
      resources:
        limits:
          memory: 512M
        reservations:
          memory: 256M
    restart: unless-stopped
    profiles:
      - monitoring