version: '3.8'

# Enhanced Cognee Database Stack
# PostgreSQL 18 + pgVector, Qdrant, Redis, Neo4j

networks:
  claude-cognee-databases-mcp:
    driver: bridge

volumes:
  enhanced_cognee_mcp_postgres_data:
    name: enhanced_cognee_mcp_postgres_data
    driver: local
  enhanced_cognee_mcp_qdrant_data:
    name: enhanced_cognee_mcp_qdrant_data
    driver: local
  enhanced_cognee_mcp_redis_data:
    name: enhanced_cognee_mcp_redis_data
    driver: local
  enhanced_cognee_mcp_neo4j_data:
    name: enhanced_cognee_mcp_neo4j_data
    driver: local
  enhanced_cognee_mcp_neo4j_logs:
    name: enhanced_cognee_mcp_neo4j_logs
    driver: local
  enhanced_cognee_mcp_neo4j_import:
    name: enhanced_cognee_mcp_neo4j_import
    driver: local

services:
  # PostgreSQL 18 + pgVector - Enhanced Cognee Database
  cognee-mcp-postgres:
    image: pgvector/pgvector:pg18
    container_name: cognee-mcp-postgres
    labels:
      - "com.enhanced-cognee.project=enhanced-cognee"
      - "com.enhanced-cognee.type=database"
      - "com.enhanced-cognee.service=postgres"
    environment:
      POSTGRES_DB: cognee_db
      POSTGRES_USER: cognee_user
      POSTGRES_PASSWORD: cognee_password
      POSTGRES_HOST_AUTH_METHOD: trust
      POSTGRES_INITDB_ARGS: "--encoding=UTF-8 --lc-collate=C --lc-ctype=C"
      POSTGRES_SHARED_PRELOAD_LIBRARIES: "vector"
    volumes:
      - enhanced_cognee_mcp_postgres_data:/var/lib/postgresql
    ports:
      - "25432:5432"  # PostgreSQL (Enhanced Cognee)
    networks:
      - claude-cognee-databases-mcp
    deploy:
      resources:
        limits:
          memory: 4G  # Increased for PostgreSQL 18 performance
        reservations:
          memory: 2G
    restart: unless-stopped
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U cognee_user -d cognee_db"]
      interval: 30s
      timeout: 10s
      retries: 3

  # Qdrant - Enhanced Cognee Vector Database
  cognee-mcp-qdrant:
    image: qdrant/qdrant:v1.12.0
    container_name: cognee-mcp-qdrant
    labels:
      - "com.enhanced-cognee.project=enhanced-cognee"
      - "com.enhanced-cognee.type=vector-db"
      - "com.enhanced-cognee.service=qdrant"
    environment:
      QDRANT__SERVICE__HTTP_PORT: 6333
      QDRANT__SERVICE__GRPC_PORT: 6334
      QDRANT__LOG_LEVEL: INFO
      QDRANT__SERVICE__MAX_REQUEST_SIZE_MB: 32
      QDRANT__STORAGE__PERFORMANCE__MAX_SEARCH_THREADS: 4
      QDRANT__STORAGE__PERFORMANCE__MAX_OPTIMIZATION_THREADS: 1
    volumes:
      - enhanced_cognee_mcp_qdrant_data:/qdrant/storage
    ports:
      - "26333:6333"  # HTTP API (Enhanced Cognee)
      - "26334:6334"  # gRPC API (Enhanced Cognee)
    networks:
      - claude-cognee-databases-mcp
    deploy:
      resources:
        limits:
          memory: 4G
        reservations:
          memory: 2G
    restart: unless-stopped
    healthcheck:
      test: ["CMD-SHELL", "[ -f /qdrant/storage/raft_state.json ] || exit 1"]
      interval: 30s
      timeout: 5s
      retries: 3
      start_period: 30s

  # Redis - Enhanced Cognee Cache Layer
  cognee-mcp-redis:
    image: redis:7.4-alpine
    container_name: cognee-mcp-redis
    labels:
      - "com.enhanced-cognee.project=enhanced-cognee"
      - "com.enhanced-cognee.type=cache"
      - "com.enhanced-cognee.service=redis"
    command: redis-server --appendonly yes --maxmemory 1gb --maxmemory-policy allkeys-lru
    volumes:
      - enhanced_cognee_mcp_redis_data:/data
    ports:
      - "26379:6379"  # Redis (Enhanced Cognee)
    networks:
      - claude-cognee-databases-mcp
    deploy:
      resources:
        limits:
          memory: 1.5G
        reservations:
          memory: 512M
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 30s
      timeout: 10s
      retries: 3

  # Neo4j - Enhanced Cognee Graph Database
  cognee-mcp-neo4j:
    image: neo4j:5.25-community
    container_name: cognee-mcp-neo4j
    hostname: cognee-mcp-neo4j
    labels:
      - "com.enhanced-cognee.project=enhanced-cognee"
      - "com.enhanced-cognee.type=graph-db"
      - "com.enhanced-cognee.service=neo4j"
    environment:
      NEO4J_AUTH: neo4j/cognee_password
      NEO4J_PLUGINS: '["apoc", "graph-data-science"]'
      NEO4J_dbms_security_procedures_unrestricted: apoc.*,gds.*
      # Neo4j 5.x compatible memory settings
      NEO4J_server_memory_heap_initial__size: 1G
      NEO4J_server_memory_heap_max__size: 2G
      NEO4J_server_memory_pagecache_size: 1G
    volumes:
      - enhanced_cognee_mcp_neo4j_data:/data
      - enhanced_cognee_mcp_neo4j_logs:/logs
      - enhanced_cognee_mcp_neo4j_import:/var/lib/neo4j/import
    ports:
      - "27474:7474"  # HTTP (Enhanced Cognee)
      - "27687:7687"  # Bolt (Enhanced Cognee)
    networks:
      - claude-cognee-databases-mcp
    deploy:
      resources:
        limits:
          memory: 3G
        reservations:
          memory: 1G
    restart: unless-stopped
    healthcheck:
      test: ["CMD-SHELL", "wget --no-verbose --tries=1 --spider http://localhost:7474/ || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s